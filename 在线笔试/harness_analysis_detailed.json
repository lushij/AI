import fitz  # PyMuPDF
import pytesseract
from PIL import Image, ImageEnhance
import io
import os
import re

class PDFDebugger:
    def __init__(self):
        """PDFè°ƒè¯•å™¨"""
        # è®¾ç½®Tesseractè·¯å¾„
        tesseract_path = r'C:\Program Files\Tesseract-OCR\tesseract.exe'
        if os.path.exists(tesseract_path):
            pytesseract.pytesseract.tesseract_cmd = tesseract_path
            print(f"âœ“ Tesseractè·¯å¾„: {tesseract_path}")
        else:
            print("âŒ Tesseractæœªæ‰¾åˆ°")

        # åˆ›å»ºè¾“å‡ºç›®å½•
        os.makedirs("debug_output", exist_ok=True)
        os.makedirs("debug_output/images", exist_ok=True)
        os.makedirs("debug_output/text", exist_ok=True)

    def debug_pdf_images(self, pdf_path):
        """
        è°ƒè¯•PDFä¸­çš„å›¾åƒ
        """
        print(f"\nğŸ” è°ƒè¯•PDFå›¾åƒ: {os.path.basename(pdf_path)}")

        doc = fitz.open(pdf_path)
        total_images = 0

        # ä¿å­˜æ‰€æœ‰OCRç»“æœ
        all_ocr_results = []

        for page_num in range(len(doc)):
            print(f"\nğŸ“– ç¬¬ {page_num + 1} é¡µ")
            page = doc[page_num]

            # è·å–å›¾åƒ
            image_list = page.get_images()

            if image_list:
                print(f"  å‘ç° {len(image_list)} ä¸ªå›¾åƒ")

                for img_idx, img_info in enumerate(image_list):
                    total_images += 1

                    try:
                        # æå–å›¾åƒ
                        xref = img_info[0]
                        base_image = doc.extract_image(xref)
                        image_bytes = base_image["image"]

                        # è·å–å›¾åƒå°ºå¯¸ä¿¡æ¯
                        width = img_info[2] if len(img_info) > 2 else 0
                        height = img_info[3] if len(img_info) > 3 else 0

                        print(f"\n    å›¾åƒ {img_idx + 1}:")
                        print(f"      å°ºå¯¸: {width} x {height}")
                        print(f"      æ ¼å¼: {base_image.get('ext', 'unknown')}")
                        print(f"      é¢œè‰²ç©ºé—´: {base_image.get('colorspace', 'unknown')}")

                        # è½¬æ¢ä¸ºPILå›¾åƒ
                        image = Image.open(io.BytesIO(image_bytes))

                        # ä¿å­˜åŸå§‹å›¾åƒ
                        orig_path = f"debug_output/images/page_{page_num+1}_img_{img_idx+1}_orig.png"
                        image.save(orig_path)

                        # å°è¯•ä¸åŒçš„å›¾åƒå¤„ç†æ–¹å¼
                        ocr_results = self._test_multiple_ocr_methods(image, page_num, img_idx)

                        if ocr_results:
                            all_ocr_results.extend(ocr_results)

                            # ä¿å­˜æœ€ä½³ç»“æœ
                            best_result = max(ocr_results, key=lambda x: x.get('score', 0))
                            print(f"      æœ€ä½³OCR: {best_result.get('text', '')[:50]}...")
                            print(f"      ç½®ä¿¡åº¦: {best_result.get('score', 0)}")

                            # ä¿å­˜å¤„ç†åçš„å›¾åƒ
                            if 'image' in best_result:
                                proc_path = f"debug_output/images/page_{page_num+1}_img_{img_idx+1}_proc.png"
                                best_result['image'].save(proc_path)

                    except Exception as e:
                        print(f"    å›¾åƒ {img_idx + 1} å¤„ç†å¤±è´¥: {e}")

            else:
                print(f"  æœ¬é¡µæ— å›¾åƒ")

        doc.close()

        # ä¿å­˜æ‰€æœ‰OCRç»“æœ
        self._save_ocr_results(all_ocr_results)

        print(f"\nğŸ“Š è°ƒè¯•å®Œæˆ:")
        print(f"  æ€»å›¾åƒæ•°: {total_images}")
        print(f"  æ€»OCRç»“æœ: {len(all_ocr_results)}")

        # åˆ†æOCRç»“æœ
        self._analyze_ocr_results(all_ocr_results)

        return all_ocr_results

    def _test_multiple_ocr_methods(self, image, page_num, img_idx):
        """
        å°è¯•å¤šç§OCRæ–¹æ³•
        """
        results = []

        # æ–¹æ³•1: åŸå§‹å›¾åƒ
        text1 = self._ocr_image(image, 'chi_sim', '--psm 6')
        if text1:
            results.append({
                'method': 'åŸå§‹å›¾åƒ',
                'text': text1,
                'page': page_num + 1,
                'image': img_idx + 1,
                'score': len(text1.strip())
            })

        # æ–¹æ³•2: ç°åº¦å›¾åƒ
        gray = image.convert('L')
        text2 = self._ocr_image(gray, 'chi_sim', '--psm 6')
        if text2 and text2 != text1:
            results.append({
                'method': 'ç°åº¦å›¾åƒ',
                'text': text2,
                'page': page_num + 1,
                'image': img_idx + 1,
                'score': len(text2.strip()),
                'image': gray
            })

        # æ–¹æ³•3: å¢å¼ºå¯¹æ¯”åº¦
        enhancer = ImageEnhance.Contrast(gray)
        enhanced = enhancer.enhance(2.0)
        text3 = self._ocr_image(enhanced, 'chi_sim', '--psm 6')
        if text3 and text3 not in [text1, text2]:
            results.append({
                'method': 'å¢å¼ºå¯¹æ¯”åº¦',
                'text': text3,
                'page': page_num + 1,
                'image': img_idx + 1,
                'score': len(text3.strip()),
                'image': enhanced
            })

        # æ–¹æ³•4: è°ƒæ•´å¤§å°ï¼ˆå¦‚æœå›¾åƒå¤ªå°ï¼‰
        if image.width < 100 or image.height < 100:
            scaled = image.resize((image.width * 2, image.height * 2), Image.Resampling.LANCZOS)
            text4 = self._ocr_image(scaled, 'chi_sim', '--psm 6')
            if text4 and text4 not in [text1, text2, text3]:
                results.append({
                    'method': 'æ”¾å¤§å›¾åƒ',
                    'text': text4,
                    'page': page_num + 1,
                    'image': img_idx + 1,
                    'score': len(text4.strip()),
                    'image': scaled
                })

        # æ–¹æ³•5: è‹±æ–‡OCR
        text5 = self._ocr_image(enhanced, 'eng', '--psm 6')
        if text5 and text5 not in [text1, text2, text3, text4]:
            results.append({
                'method': 'è‹±æ–‡OCR',
                'text': text5,
                'page': page_num + 1,
                'image': img_idx + 1,
                'score': len(text5.strip()),
                'image': enhanced
            })

        # æ–¹æ³•6: ä¸­è‹±æ–‡æ··åˆ
        text6 = self._ocr_image(enhanced, 'chi_sim+eng', '--psm 6')
        if text6 and text6 not in [text1, text2, text3, text4, text5]:
            results.append({
                'method': 'ä¸­è‹±æ–‡æ··åˆ',
                'text': text6,
                'page': page_num + 1,
                'image': img_idx + 1,
                'score': len(text6.strip()),
                'image': enhanced
            })

        return results

    def _ocr_image(self, image, lang, config):
        """
        OCRè¯†åˆ«
        """
        try:
            text = pytesseract.image_to_string(image, lang=lang, config=config)
            return text.strip()
        except:
            return ""

    def _save_ocr_results(self, results):
        """
        ä¿å­˜OCRç»“æœ
        """
        # æŒ‰é¡µé¢åˆ†ç»„ä¿å­˜
        by_page = {}
        for result in results:
            page = result['page']
            if page not in by_page:
                by_page[page] = []
            by_page[page].append(result)

        # ä¿å­˜æ¯ä¸ªé¡µé¢çš„ç»“æœ
        for page, page_results in by_page.items():
            with open(f"debug_output/text/page_{page}_ocr.txt", "w", encoding="utf-8") as f:
                f.write(f"=== ç¬¬ {page} é¡µ OCR ç»“æœ ===\n\n")

                # æŒ‰å›¾åƒåˆ†ç»„
                by_image = {}
                for result in page_results:
                    img = result['image']
                    if img not in by_image:
                        by_image[img] = []
                    by_image[img].append(result)

                for img in sorted(by_image.keys()):
                    f.write(f"å›¾åƒ {img}:\n")
                    f.write("-" * 40 + "\n")

                    for result in by_image[img]:
                        f.write(f"æ–¹æ³•: {result['method']}\n")
                        f.write(f"å¾—åˆ†: {result['score']}\n")
                        f.write(f"æ–‡æœ¬: {result['text']}\n")
                        f.write("-" * 20 + "\n")

                    f.write("\n")

        # ä¿å­˜æ±‡æ€»
        with open("debug_output/text/all_ocr_summary.txt", "w", encoding="utf-8") as f:
            f.write("=== æ‰€æœ‰OCRç»“æœæ±‡æ€» ===\n\n")

            for result in sorted(results, key=lambda x: (x['page'], x['image'], -x['score'])):
                f.write(f"ç¬¬{result['page']}é¡µ-å›¾åƒ{result['image']}: ")
                f.write(f"[{result['method']}] ")
                f.write(f"({result['score']}å­—ç¬¦) ")
                f.write(f"{result['text'][:100]}\n")

    def _analyze_ocr_results(self, results):
        """
        åˆ†æOCRç»“æœ
        """
        print(f"\nğŸ“Š OCRç»“æœåˆ†æ:")

        if not results:
            print("  æ²¡æœ‰OCRç»“æœ")
            return

        # ç»Ÿè®¡
        total_chars = sum(len(r['text']) for r in results)
        avg_chars = total_chars / len(results) if results else 0

        print(f"  å¹³å‡æ¯ä¸ªç»“æœå­—ç¬¦æ•°: {avg_chars:.1f}")

        # æŸ¥æ‰¾æœ€é•¿çš„ç»“æœ
        longest = max(results, key=lambda x: len(x['text'])) if results else None
        if longest:
            print(f"  æœ€é•¿ç»“æœ: {len(longest['text'])} å­—ç¬¦")
            print(f"    æ¥è‡ª: ç¬¬{longest['page']}é¡µ-å›¾åƒ{longest['image']}")
            print(f"    æ–¹æ³•: {longest['method']}")
            print(f"    å†…å®¹: {longest['text'][:100]}...")

        # æ£€æŸ¥æ˜¯å¦åŒ…å«å…ƒå™¨ä»¶å…³é”®è¯
        keywords = ['æ¶²æ™¶', 'å±å¹•', 'ä¼ æ„Ÿå™¨', 'å¼€å…³', 'è¿æ¥å™¨', 'ECU', 'ç”µæœº', 'ç¯', 'ä»ªè¡¨', 'çº¿æŸ']

        print(f"\nğŸ” å…³é”®è¯æ£€æŸ¥:")
        found_keywords = {}

        for result in results:
            text = result['text']
            for keyword in keywords:
                if keyword in text:
                    if keyword not in found_keywords:
                        found_keywords[keyword] = []
                    found_keywords[keyword].append(result)

        if found_keywords:
            for keyword, matches in found_keywords.items():
                print(f"  âœ“ æ‰¾åˆ° '{keyword}': {len(matches)} æ¬¡")
                for match in matches[:2]:  # æ˜¾ç¤ºå‰2ä¸ª
                    print(f"    ç¬¬{match['page']}é¡µ-å›¾åƒ{match['image']}: {match['text'][:50]}...")
        else:
            print(f"  âš ï¸ æœªæ‰¾åˆ°ä»»ä½•å…ƒå™¨ä»¶å…³é”®è¯")

            # æ˜¾ç¤ºä¸€äº›å®é™…è¯†åˆ«çš„å†…å®¹
            print(f"\nğŸ“ å®é™…è¯†åˆ«çš„å†…å®¹ç¤ºä¾‹:")
            sample_results = sorted(results, key=lambda x: len(x['text']), reverse=True)[:5]
            for i, result in enumerate(sample_results, 1):
                if result['text']:
                    print(f"  {i}. ç¬¬{result['page']}é¡µ-å›¾åƒ{result['image']}: {result['text'][:50]}")

    def extract_pdf_metadata(self, pdf_path):
        """
        æå–PDFå…ƒæ•°æ®
        """
        print(f"\nğŸ“„ æå–PDFå…ƒæ•°æ®: {os.path.basename(pdf_path)}")

        doc = fitz.open(pdf_path)

        # åŸºæœ¬å…ƒæ•°æ®
        metadata = doc.metadata
        print(f"  æ ‡é¢˜: {metadata.get('title', 'æ— ')}")
        print(f"  ä½œè€…: {metadata.get('author', 'æ— ')}")
        print(f"  ä¸»é¢˜: {metadata.get('subject', 'æ— ')}")
        print(f"  å…³é”®è¯: {metadata.get('keywords', 'æ— ')}")
        print(f"  åˆ›å»ºè€…: {metadata.get('creator', 'æ— ')}")
        print(f"  åˆ›å»ºæ—¶é—´: {metadata.get('creationDate', 'æ— ')}")

        # é¡µé¢ä¿¡æ¯
        print(f"\nğŸ“Š é¡µé¢è¯¦ç»†ä¿¡æ¯:")
        for page_num in range(len(doc)):
            page = doc[page_num]

            # è·å–é¡µé¢æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
            text = page.get_text()
            text_length = len(text.strip())

            # è·å–å›¾åƒ
            images = page.get_images()

            # è·å–çŸ¢é‡å›¾å½¢
            drawings = page.get_drawings()

            print(f"\n  ç¬¬ {page_num + 1} é¡µ:")
            print(f"    æ–‡æœ¬é•¿åº¦: {text_length} å­—ç¬¦")
            print(f"    å›¾åƒæ•°é‡: {len(images)}")
            print(f"    çŸ¢é‡å›¾å½¢: {len(drawings)}")

            # å¦‚æœæœ‰æ–‡æœ¬ï¼Œæ˜¾ç¤ºç‰‡æ®µ
            if text_length > 0:
                print(f"    æ–‡æœ¬é¢„è§ˆ: {text.strip()[:100]}...")

            # å›¾åƒè¯¦ç»†ä¿¡æ¯
            if images:
                print(f"    å›¾åƒè¯¦æƒ…:")
                for i, img in enumerate(images[:3]):  # åªæ˜¾ç¤ºå‰3ä¸ª
                    print(f"      å›¾åƒ{i+1}: {img[2]}x{img[3]}")

        doc.close()

        # ä¿å­˜å…ƒæ•°æ®
        with open("debug_output/pdf_metadata.txt", "w", encoding="utf-8") as f:
            f.write("=== PDFå…ƒæ•°æ® ===\n\n")
            for key, value in metadata.items():
                f.write(f"{key}: {value}\n")

        print(f"\nâœ… å…ƒæ•°æ®å·²ä¿å­˜åˆ°: debug_output/pdf_metadata.txt")


def main():
    """
    ä¸»ç¨‹åº - PDFè°ƒè¯•å™¨
    """
    print("=" * 80)
    print("ğŸ”¬ PDFè°ƒè¯•ä¸åˆ†æå·¥å…·")
    print("=" * 80)
    print("è¯´æ˜: åˆ†æPDFç»“æ„ï¼Œè°ƒè¯•OCRè¯†åˆ«é—®é¢˜")
    print("=" * 80)

    # æ£€æŸ¥ä¾èµ–
    try:
        import fitz
        import pytesseract
        from PIL import Image
        print("âœ“ æ‰€æœ‰ä¾èµ–åº“å·²å®‰è£…")
    except ImportError as e:
        print(f"âŒ ç¼ºå°‘ä¾èµ–åº“: {e}")
        print("\nè¯·å®‰è£…: pip install PyMuPDF pytesseract pillow")
        return

    # PDFæ–‡ä»¶
    pdf_path = "test.pdf"
    if not os.path.exists(pdf_path):
        print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {pdf_path}")
        print("å½“å‰ç›®å½•:", os.listdir('.'))
        return

    print(f"âœ“ åˆ†ææ–‡ä»¶: {pdf_path}")

    # åˆ›å»ºè°ƒè¯•å™¨
    debugger = PDFDebugger()

    print(f"\né€‰æ‹©è°ƒè¯•æ¨¡å¼:")
    print("1. å®Œæ•´è°ƒè¯•ï¼ˆå›¾åƒOCR + å…ƒæ•°æ®ï¼‰")
    print("2. åªè°ƒè¯•å›¾åƒOCR")
    print("3. åªæå–å…ƒæ•°æ®")

    choice = input("\nè¯·é€‰æ‹© (1/2/3, é»˜è®¤1): ").strip() or "1"

    if choice in ["1", "2"]:
        print(f"\n{'='*80}")
        print("å¼€å§‹è°ƒè¯•å›¾åƒOCR...")
        print("=" * 80)

        # è°ƒè¯•å›¾åƒOCR
        results = debugger.debug_pdf_images(pdf_path)

        if not results:
            print("\nâš ï¸ è­¦å‘Š: æ²¡æœ‰OCRç»“æœæˆ–å›¾åƒæ— æ³•è¯†åˆ«")
            print("å¯èƒ½åŸå› :")
            print("  1. PDFä¸­çš„'å›¾åƒ'å®é™…ä¸Šæ˜¯çŸ¢é‡å›¾å½¢")
            print("  2. å›¾åƒè´¨é‡å¤ªå·®")
            print("  3. å›¾åƒå¤ªå°")
            print("  4. å›¾åƒæ˜¯å›¾æ ‡æˆ–ç¬¦å·ï¼Œä¸æ˜¯æ–‡å­—")

    if choice in ["1", "3"]:
        print(f"\n{'='*80}")
        print("æå–PDFå…ƒæ•°æ®...")
        print("=" * 80)

        # æå–å…ƒæ•°æ®
        debugger.extract_pdf_metadata(pdf_path)

    print(f"\n{'='*80}")
    print("è°ƒè¯•å®Œæˆ!")
    print("=" * 80)
    print("\nç”Ÿæˆçš„æ–‡ä»¶:")
    print("  debug_output/images/ - åŸå§‹å’Œå¤„ç†åçš„å›¾åƒ")
    print("  debug_output/text/ - OCRè¯†åˆ«ç»“æœ")
    print("  debug_output/pdf_metadata.txt - PDFå…ƒæ•°æ®")

    # æä¾›å»ºè®®
    print(f"\nğŸ’¡ åŸºäºåˆ†æçš„å»ºè®®:")
    print("  1. æŸ¥çœ‹ debug_output/text/ ä¸­çš„OCRç»“æœ")
    print("  2. å¦‚æœOCRç»“æœå¤ªçŸ­ï¼Œå¯èƒ½æ˜¯å›¾åƒè´¨é‡é—®é¢˜")
    print("  3. è€ƒè™‘ä½¿ç”¨çŸ¢é‡å›¾å½¢æå–è€ŒéOCR")
    print("  4. æˆ–è€…PDFæœ¬èº«å°±æ˜¯çŸ¢é‡å›¾ï¼Œéœ€è¦ä¸åŒæ–¹æ³•")


if __name__ == "__main__":
    main()